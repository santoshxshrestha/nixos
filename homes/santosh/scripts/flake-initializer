#!/usr/bin/env bash
if [ -z "$1" ]; then
    echo "Usage: $0 <flake-type> [--local]"
    echo "Example: $0 rust"
    echo "Example: $0 rust --local"
    exit 1
fi

FLAKE_TYPE="$1"
LOCAL_FLAG="$2"

if [ "$LOCAL_FLAG" = "--local" ]; then
    echo "Setting up local flake files..."
    curl -O "https://raw.githubusercontent.com/santoshxshrestha/initflake/main/$FLAKE_TYPE/flake.nix"
    curl -O "https://raw.githubusercontent.com/santoshxshrestha/initflake/main/$FLAKE_TYPE/flake.lock"
    # if curl --fail -O "https://raw.githubusercontent.com/santoshxshrestha/initflake/main/$FLAKE_TYPE/nix/default.nix"; then
    #     echo "Downloaded default.nix"
    #     mkdir nix && mv default.nix nix/
    # else
    #     echo "default.nix does not exist in the repository, skipping..."
    # fi

    if [ -d ".git" ]; then
        echo "Git repository detected, adding files to git..."
        echo ".direnv/" >>.gitignore
        git add .gitignore
        git commit -m "chore(git): add .direnv to .gitignore"
        echo "use flake" >.envrc
        # git add flake.nix flake.lock .envrc nix/default.nix
        git add flake.nix flake.lock .envrc 
        git commit -m "chore(flakes): add initial flake.nix, default.nix, and flake.lock"
    else
        echo "No git repository found, skipping git operations"
        echo ".direnv/" >>.gitignore
        echo "use flake" >.envrc
    fi

    direnv allow
    echo "✓ Local flake files downloaded and configured"
else
    echo "Setting up remote flake reference..."
    echo "use flake \"github:santoshxshrestha/initflake?dir=$FLAKE_TYPE\"" >.envrc
    direnv allow
    echo "✓ Remote flake configured"
fi

echo "Development environment ready!"
